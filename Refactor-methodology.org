* Bulgaria-geocoding Refactor Methodology
** Overview
This sheet provides an insight of the fixes done to the Bulgaria Mapping Dataset after the fork from [[https://github.com/yurukov/Bulgaria-geocoding]].

*** Why fixing it?
+ *Because fixes were needed* -- The original source used for the generation of the generalized polygons for the settlement borders has many issues, most importantly its age (many changes not reflected). That was leading to innacuracies that were sometimes visible (e.g. mapping data for merged grounds result in holes), and sometimes not visible on the produced maps (multiple settlements sharing grounds should have their data aggregated).
+ *Because such sources are needed* -- Bulgarian institutions have a history of unwillingness to share geospatial data created with public funds. The data that is shared is often of low quality or presented in unusable form. Bulgaria continues to be non-compliant with the agreed process for sharing geospatial data [[#link_1]] [[#link_2]] in many ways, because people that should be stewards of that data treat it as its owners.
+ *Because I can* -- Having over ten years of experience wrangling geospatial data allows me to do the fixes relatively quickly and without much trouble. I love mapping and data visualization and because of that and the reasons above I decided to help with the data cleanup.

*** Benefits provided by this fix
+ Alignment of administrative boundaries between features in the same layer. Each administrative polygon layer complies with the following topology rules:
  - [X] =Must not have Gaps=
  - [X] =Must Not Overlap=

+ Alignment of administrative boundaries between features in different layers. This is the result of generating the admin layers with a bottom-up approach, merging features from the lower administrative level to provide the higher one, e.g. merging settlements with the same municipality code is used to generate the features for the municipality layer.

+ Consistency in the structure of the administrative levels by providing a .geojson file for each of the recognized administrative levels:
|----------------------+--------------------+------------+--------------------------+---+-------------|
| Administrative Level | Description        | NUTS Level | File Name                |   | Feat. Count |
|----------------------+--------------------+------------+--------------------------+---+-------------|
| Country              | Държава            | /N/A/        | =country.geojson=          |   |           1 |
| Region               | Район              | NUTS 1     | =regions.geojson=          |   |           2 |
| Planning Region      | Район за планиране | NUTS 2     | =planning-regions.eeojson= |   |           6 |
| Province             | Област             | NUTS 3     | =provinces.geojson=        |   |          28 |
| Municipality         | Община             | LAU        | =municipalities.geojson=   |   |         265 |
| Settlement Ground    | Землище            | /N/A/        | =settlements.geojson=      |   |        4614 |
| Settlement           |                    | /N/A/        |                          |   |             |
|----------------------+--------------------+------------+--------------------------+---+-------------|

+ Consistency in the geospatial and attribute data: The data has been separated into two types -- geospatial data is all data that carries the coordinates of the features (e.g. a =.geojson= file with the municipalities) and the identifiers that allow for joining to an attribute data source. The attribute data sources are presented as =.csv= files and can be joined to a geospatial dataset via any of the identifier fields (e.g. =EKATTE_ID=). That keeps the geospatial layers lighter while allowing them to be joined to different data sources depending on the usage.
  
*** What this refactor does not fix?
+ The refactor does not keep track of the historical changes to the administrative structure over the years. 
+ Many of the manual changes to the data made can be automated at least to some extent. This is also (currently) not provided. Checks of future data editions are also a good candidate for automation.
+ The geometry of the grounds polygons can be further improved by trying different generalization algorithms and by manual fixing.

** Topology Refactor
+ Objectives:
  - Fix the topology of the =settlements.geojson= file to allow for it to be used for further dataset improvements.
+ More about topology rules and fixes [[http://wiki.gis.com/wiki/index.php/Topology][here]] or [[https://desktop.arcgis.com/en/arcmap/latest/manage-data/editing-topology/geodatabase-topology-rules-and-topology-error-fixes.htm][here]].

+ Fixes:
  - To determine the amount of fixes needed to the dataset I used the =Topology Checker= plugin for QGIS. 
  - The check for gaps and overlaps yielded 247 errors. 
  - The fixes were performed manually.

[[./screenshots/topology_errors.png]]
[[./screenshots/topology_errors_2.png]]

** Administrative Layers Refactor
+ Objectives:
  - Generate polygon .geojson files from the fixed settlement boundary layer for municipalities and provinces in Bulgaria.
  - Generate polygon .geojson files for the NUTS 0-3 levels using the created provinces files.
  - Update the schema for all layers for consistency.
  - Use EKATTE to fill in identifier fields for all layers.

*** Settlements Grounds (Zemlishta) Layer
+ 4621 Features. This layer will also require further cleanup to correctly match the reality.
#+CAPTION: Attribute Table Fields for settlements.geojson
|-------------------+-----------+--------------------------------------------------------------------|
| Field             | Data Type | Contains                                                           |
|-------------------+-----------+--------------------------------------------------------------------|
| EKATTE_ID         | String    | The ID given to this administrative unit in EKATTE.                |
| NAME_BG           | String    | The name of this administrative unit in Bulgarian.                 |
| NAME_EN           | String    | The transliterated name of this administrative unit.               |
| TYPE_BG           | String    | The type of settlement in Bulgarian (village, city).               |
| TYPE_EN           | String    | The type of settlement in English.                                 |
| PROVINCE_CODE     | String    | The code of the Oblast (Province) this settlement belongs to.      |
| MUNICIPALITY_CODE | String    | The code of the Obstina (Municipality) this settlement belongs to. |
|-------------------+-----------+--------------------------------------------------------------------|

[[./screenshots/new-settlements.geojson.png]]

*** Municipalities (Obshtini) Layer
+ 265 Features -- one for each municipality in Bulgaria.

#+CAPTION: Attribute Table Fields for municipalities.geojson
|---------------+-----------+-----------------------------------------------------------------------------|
| Field         | Data Type | Contains                                                                    |
|---------------+-----------+-----------------------------------------------------------------------------|
| EKATTE_ID     | String    | The ID given to this administrative unit in EKATTE.                         |
| NAME_BG       | String    | The name of the administrative unit in Bulgarian.                           |
| NAME_EN       | String    | The transliterated name of this administrative unit.                        |
| PROVINCE_CODE | String    | The code of the Oblast (Province) this municipality belongs to from EKATTE. |
| LAU_CODE      | String    | The code of the Obstina (Municipality) according to NUTS.                   |
| NUTS_1_CODE   | String    | The code of the Region a feature belongs to according to NUTS.              |
| NUTS_2_CODE   | String    | The code of the Planning a feature belongs to according to NUTS.            |
| NUTS_3_CODE   | String    | The code of this Oblast (Province) according to NUTS.                       |
|---------------+-----------+-----------------------------------------------------------------------------|

[[./screenshots/new-municipalities.geojson.png]]

*** Provinces Layer
+ 28 Features -- One for each province in Bulgaria.
#+CAPTION: Attribute Table Fields for provinces.geojson
|---------------+-----------+------------------------------------------------------------------|
| Field         | Data Type | Contains                                                         |
|---------------+-----------+------------------------------------------------------------------|
| EKATTE_ID     | String    | The ID given to this administrative unit in EKATTE.              |
| NAME_BG       | String    | The name of this administrative unit in Bulgarian.               |
| NAME_EN       | String    | The name of this administrative unit in English (transliterated) |
| PROVINCE_CODE | String    | The code of the Oblast (Province) from EKATTE.                   |
| NUTS_1_CODE   | String    | The code of the Region a feature belongs to according to NUTS.   |
| NUTS_2_CODE   | String    | The code of the Planning a feature belongs to according to NUTS. |
| NUTS_3_CODE   | String    | The code of this Oblast (Province) according to NUTS.            |
|---------------+-----------+------------------------------------------------------------------|

[[./screenshots/new-provinces.geojson.png]]

*** NUTS Level 2 -- Planning Regions
+ Planning Regions (NUTS 2)
#+CAPTION: Attribute Table Fields for planning-regions.geojson
|-------------+-----------+----------------------------------------------------------------|
| Field       | Data Type | Contains                                                       |
|-------------+-----------+----------------------------------------------------------------|
| NAME_BG     | String    | The name of this administrative unit in Bulgarian.             |
| NAME_EN     | String    | The feature's translated name.                                 |
| NUTS_1_CODE | String    | The code of the Region a feature belongs to according to NUTS. |
| NUTS_2_CODE | String    | The code of this Planning Region according to NUTS.            |
|-------------+-----------+----------------------------------------------------------------|

[[./screenshots/new-planning-regions.png]]

*** NUTS Level 1 -- Regions
+ Regions (NUTS 1)
#+CAPTION: Attribute Table Fields for regions.geojson
|-------------+-----------+----------------------------------------------------|
| Field       | Data Type | Contains                                           |
|-------------+-----------+----------------------------------------------------|
| NAME_BG     | String    | The name of this administrative unit in Bulgarian. |
| NAME_EN     | String    | The feature's translated name.                     |
| NUTS_1_CODE | String    | The code of this NUTS 1 feature.                   |
|-------------+-----------+----------------------------------------------------|

[[./screenshots/new-regions.png]]

*** Country Polygon
+ Country Polygon
#+CAPTION: Attribute Table Fields for country.geojson
|--------------+-----------+----------------------------------------------------|
| Field        | Data Type | Contains                                           |
|--------------+-----------+----------------------------------------------------|
| NAME_BG      | String    | The name of this administrative unit in Bulgarian. |
| NAME_EN      | String    | The feature's translated name.                     |
| COUNTRY_CODE | String    | Country code.                                      |
|--------------+-----------+----------------------------------------------------|

[[./screenshots/new-country.geojson.png]]

** EKATTE Data Align
+ Objectives: 
  - Alignment between repository dataset and official data from EKATTE.

*** Fixes:
+ After joining the EKATTE table of all settlements to the settlement grounds I used the output of the non-matched settlements to query the EKATTE web site for the information of where those settlements belonged. I could not find this information easily mapped in any of the tables they provide to download so I had to do this operation manually. 

The resulting information is incorporated into the settlements layer: 
[[./screenshots/shared_grounds.png]]


[[./screenshots/removed_admins.png]]
+ Manual fixes to reflect EKATTE
|-------------------------+------------+-------------+-----------------------------------------------------------------------------------------------------------------|
| Settlement              | Obshtina   | Oblast      | Fix                                                                                                             |
|-------------------------+------------+-------------+-----------------------------------------------------------------------------------------------------------------|
| Budiltsi (06834)        | Kresna     | Blagoevgrad | Merged with Slivnitsa (67369)                                                                                   |
| Balabanchevo (02322)    | Sungurlare | Burgas      | Merged with Sungurlare (70247)                                                                                  |
| Zhelezari (29088)       | Omurtag    | Targovishte | Abolished. Polygon merged with Iliyno (32620)                                                                   |
| Vetren (29427)          | Burgas     | Burgas      | Merged with Burgas (07079)                                                                                      |
| Kamensko (35924)        | Sungurlare | Burgas      | Abolished. Polygon merged with Manolich (47096)                                                                 |
| Rudnik (63183)          | Burgas     | Burgas      | Merged with Burgas (07079)                                                                                      |
| Modren (68151)          | Dzhebel    | Kardzhali   | Merged with Mishevsko (48622)                                                                                   |
| Fabrika (76011)         | Zlatograd  | Smolyan     | Merged with Startsevo (59344) because could not form multipart polygon with Zlatograd (data format restriction) |
| Halovski kolibi (77133) | Boynitsa   | Vidin       | Abolished. Merged with Shishentsi (83329) because of proximity.                                                 |
|-------------------------+------------+-------------+-----------------------------------------------------------------------------------------------------------------|

** Merge Preparation
+ Objective: 
  - Prepare dataset for pull request.

+ Directory structure updated:
  - =data/= directory to hold datasets related to the geospatial layers.

** Resources:
To perform the fixes detailed in this document I used the following resources:

+ Data:
  - NSI
  - Infostat System of the National Statistical Institute -- [[https://infostat.nsi.bg/infostat]]
  - EKATTE

+ Tools:
  - QGIS 2.18
  - LibreOffice 6.0
  - GIMP 2.10
  - Spacemacs
  - Python 3.6

** References
<<link_1>> [[http://cdr.eionet.europa.eu/bg/eu/inspire/monitoring/envwsvmjq/][Monitoring of implementation and use of infrastructures for spatial information]]
<<link_2>> https://inspire.ec.europa.eu/sites/default/files/inspirecountryfichebulgaria_2016.pdf
